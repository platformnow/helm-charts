name: Add Helm Chart

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Helm repository name (e.g., external-dns)'
        required: true
      repo_url:
        description: 'Helm repository URL (e.g., https://kubernetes-sigs.github.io/external-dns/)'
        required: true
      chart_name:
        description: 'Chart name (e.g., external-dns)'
        required: true
      chart_version:
        description: 'Chart version (e.g., 1.15.0)'
        required: true

jobs:
  add-chart:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@b9e51907a09c216f16ebe8536097933489208112 # v4.3.0
        with:
          version: v3.12.0

      - name: Add Helm repository
        run: |
          echo "Adding Helm repository ${{ github.event.inputs.repo_name }} (${{ github.event.inputs.repo_url }})"
          helm repo add ${{ github.event.inputs.repo_name }} ${{ github.event.inputs.repo_url }}
          helm repo update

      - name: Pull and untar chart
        working-directory: charts
        run: |
          echo "Pulling chart ${{ github.event.inputs.chart_name }} version ${{ github.event.inputs.chart_version }}"
          
          # Check if chart directory already exists
          if [ -d "${{ github.event.inputs.chart_name }}" ]; then
            echo "Warning: Chart directory already exists. Contents will be overwritten."
            # Remove existing directory to ensure clean extraction
            rm -rf "${{ github.event.inputs.chart_name }}"
          fi
          
          # Pull the chart
          helm pull ${{ github.event.inputs.repo_name }}/${{ github.event.inputs.chart_name }} \
            --untar \
            --version ${{ github.event.inputs.chart_version }}
          
          echo "Chart extracted to charts/${{ github.event.inputs.chart_name }}"

      - name: Update ct.yaml with new repository
        run: |
          echo "Checking if repository is already in ct.yaml"
          if ! grep -q "${{ github.event.inputs.repo_name }}=${{ github.event.inputs.repo_url }}" .github/linters/ct.yaml; then
            echo "Adding repository to ct.yaml"
            # Use yq to add the new repository to the chart-repos list
            yq -i '.chart-repos += ["${{ github.event.inputs.repo_name }}=${{ github.event.inputs.repo_url }}"]' .github/linters/ct.yaml
            echo "Repository added to ct.yaml"
          else
            echo "Repository already exists in ct.yaml"
          fi

      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Create branch
        run: |
          # Create a new branch with a unique name
          BRANCH_NAME="add-chart-${{ github.event.inputs.chart_name }}-${{ github.event.inputs.chart_version }}-$(date +%s)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME

      - name: Commit changes
        run: |
          git add charts/${{ github.event.inputs.chart_name }}
          git add .github/linters/ct.yaml
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "feat(new chart): add ${{ github.event.inputs.chart_name }} chart version ${{ github.event.inputs.chart_version }}"
          git push origin ${{ env.BRANCH_NAME }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@70a41aba780001da0a30141984ae2a0c95d8704e # v6.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(new chart): add ${{ github.event.inputs.chart_name }} chart version ${{ github.event.inputs.chart_version }}"
          title: "feat(new chart): add ${{ github.event.inputs.chart_name }} chart version ${{ github.event.inputs.chart_version }}"
          body: |
            This PR adds the ${{ github.event.inputs.chart_name }} Helm chart version ${{ github.event.inputs.chart_version }}.
            
            Chart repository: ${{ github.event.inputs.repo_name }} (${{ github.event.inputs.repo_url }})
            
            This PR was created automatically by the Add Helm Chart workflow.
          branch: ${{ env.BRANCH_NAME }}
          base: main
          labels: |
            helm-chart
            automated-pr 